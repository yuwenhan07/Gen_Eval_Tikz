\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,bending,calc,fit,patterns}
\usepackage{xcolor}

\begin{document}

\begin{tikzpicture}[font=\scriptsize,scale=1.0,every node/.style={minimum size=.6cm}, >=stealth',bend angle=30]
    \def\a{1.7}
    \def\b{4}
    \def\d{1.2}
    \def\e{0.7}
    \def\w{0.9}
    \def\s{2.7}
    \def\m{2.3}
    \node[circle,draw,thick] (add) at (\a,\b) {Add};
    \node[circle,draw,thick] (norm) at (\a,\d) {Norm};
    \node[circle,draw,thick] (feed_up) at (\a,\e) {\textbf{Feed Forward Up}};
    \node[circle,draw,thick] (feed_down) at (\a,\m) {\textbf{Feed Forward Down}};
    \node[circle,draw,thick] (norm2) at (\a,\s) {Norm};
    \node[circle,draw,thick] (adapt) at (\a,\b+.5) {\textbf{Adapter}};
    \node[circle,draw,thick] (feed) at (\a,\w) {\textbf{Feed Forward}};
    \node[circle,draw,thick] (add_norm) at (\a,\w-.5) {Add \& Norm};
    \node[circle,draw,thick] (multihead) at (\a,\w-.75) {\textbf{Multi-Head Attention}};

    \draw[->] (multihead.south) -- ++(0,-0.3) -| ($(feed.north)+(0,-0.3)$);
    \draw[->] ($(feed.north)+(0,-0.3)$) |- ($(feed_down.south)-(0,0.3)$);
    \draw[->] (feed_down.south) -- ++(0,-0.5) -| ($(adapt.north)+(0,-0.2)$);
    \draw[->] ($(adapt.north)+(0,-0.2)$) |- ($(adapt.south)+(0,0.3)$);
    \draw[->] (adapt.south) -- ++(0,-0.5) -| ($(norm.north)+(0,-0.2)$);
    \draw[->] ($(norm.north)+(0,-0.2)$) |- ($(norm.south)+(0,0.3)$);
    \draw[->] (norm.south) -- ++(0,-0.5) -| ($(feed_up.north)+(0,-0.2)$);
    \draw[->] ($(feed_up.north)+(0,-0.2)$) |- ($(feed_up.south)+(0,0.3)$);
    \draw[->] (feed_up.south) -- ++(0,-0.5) -| ($(norm2.north)+(0,-0.2)$);
    \draw[->] ($(norm2.north)+(0,-0.2)$) |- ($(norm2.south)+(0,0.3)$);
    \draw[->] (norm2.south) -- ++(0,-0.5) -| ($(add_norm.north)+(0,-0.2)$);
    \draw[->] ($(add_norm.north)+(0,-0.2)$) |- ($(add_norm.south)+(0,0.3)$);
    \draw[->] (add_norm.south) -- ++(0,-0.5) -| ($(add.north)+(0,-0.2)$);
    \draw[->] ($(add.north)+(0,-0.2)$) |- ($(add.south)+(0,0.3)$);

    \node[circle,draw,thick] (norm3) at (\a+0.5,\b) {Norm};
    \node[circle,draw,thick] (add_norm) at (\a+0.5,\d) {Add \& Norm};
    \node[circle,draw,thick] (add) at (\a+0.5,\w-.75) {Add};
    \node[circle,draw,thick] (norm) at (\a+0.5,\w-.5) {Norm};
    \node[circle,draw,thick] (feed) at (\a+0.5,\w-.25) {Feed Forward};
    \node[circle,draw,thick] (multihead) at (\a+0.5,\w) {Multi-Head Attention};

    \draw[dashed,fill=red!15] (add_norm.north west) rectangle (norm.south east);
    \draw[dashed,fill=blue!15] (norm.south west) rectangle (feed_up.north east);

    \draw[->] (multihead.south) -- ++(0,-0.3) -| ($(feed.north)+(0,-0.3)$);
    \draw[->] ($(feed.north)+(0,-0.3)$) |- ($(feed_down.south)-(0,0.3)$);
    \draw[->] (feed_down.south) -- ++(0,-0.5) -| ($(adapt.north)+(0,-0.2)$);
    \draw[->] ($(adapt.north)+(0,-0.2)$) |- ($(adapt.south)+(0,0.3)$);
    \draw[->] (adapt.south) -- ++(0,-0.5) -| ($(norm.north)+(0,-0.2)$);
    \draw[->] ($(norm.north)+(0,-0.2)$) |- ($(norm.south)+(0,0.3)$);
    \draw[->] (norm.south) -- ++(0,-0.5) -| ($(feed_up.north)+(0,-0.2)$);
    \draw[->] ($(feed_up.north)+(0,-0.2)$) |- ($(feed_up.south)+(0,0.3)$);
    \draw[->] (feed_up.south) -- ++(0,-0.5) -| ($(norm2.north)+(0,-0.2)$);
    \draw[->] ($(norm2.north)+(0,-0.2)$) |- ($(norm2.south)+(0,0.3)$);
    \draw[->] (norm2.south) -- ++(0,-0.5) -| ($(add_norm.north)+(0,-0.2)$);
    \draw[->] ($(add_norm.north)+(0,-0.2)$) |- ($(add_norm.south)+(0,0.3)$);
    \draw[->] (add_norm.south) -- ++(0,-0.5) -| ($(add.north)+(0,-0.2)$);
    \draw[->] ($(add.north)+(0,-0.2)$) |- ($(add.south)+(0,0.3)$);

    \node[circle,draw,thick] (norm3) at (\a+0.5,\b) {Norm};
    \node[circle,draw,thick] (add_norm) at (\a+0.5,\d) {Add \& Norm};
    \node[circle,draw,thick] (add) at (\a+0.5,\w-.75) {Add};
    \node[circle,draw,thick] (norm) at (\a+0.5,\w-.5) {Norm};
    \node[circle,draw,thick] (feed) at (\a+0.5,\w-.25) {Feed Forward};
    \node[circle,draw,thick] (multihead) at (\a+0.5,\w) {Multi-Head Attention};

    \draw[dashed,fill=red!15] (add_norm.north west) rectangle (norm.south east);
    \draw[dashed,fill=blue!15] (norm.south west) rectangle (feed_up.north east);
    \draw[dotted] (\a+.5,\w+.4)--+(\a+.5+\b+.5,0)--+(\a+\b+.5,\w+.4)--(\a+\b+.5,\w+.4-2*\e)--(\a+.5,\w+.4-2*\e)--(\a+.5,\w+.4);
    \draw[dotted] (\a+.5+\b+.5,\w+.4)--+(\a+.5+\b+.5,\w+.4-2*\e)--+(\a+\b+.5,\w+.4-2*\e)--(\a+\b+.5,\w+.4)--(\a+.5+\b+.5,\w+.4);
    \node[circle,draw,thick] (adapt) at (\a+.5+\b+.5,\w+.4-2*\e) {\textbf{Adapter}};

    \draw[->] (adapt.south) -- ++(0,-0.5) -| ($(adapt.north)+(0,-0.2)$);
    \draw[->